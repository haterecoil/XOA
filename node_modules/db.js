db = module.exports = {
  mysql : require('mysql'),
  mySqlClient : null,
 
  connect : function () {
    this.mysql = require('mysql');
    this.mySqlClient = this.mysql.createConnection({
      host     : "localhost",
      port     : "8889",
      user     : "root",
      password : "root",
      database : "xoa-dev"
    });  
  },
 
  close : function() {
    this.mySqlClient.end();
  },
 
  executeSelectQuery : function( selectQuery, callbackResultFunction ) {
    this.mySqlClient.query(
      selectQuery,
      function select(error, results, fields) {
        if (error) {
          console.log(error);
          db.mySqlClient.end();
          return;
        }
   
        if ( results.length > 0 )  { 
          callbackResultFunction(results);
        } else {
          console.log("Pas de données");
        }
        db.mySqlClient.end();
    });
  },

  executeInsertQuery : function ( insertQuery, callbackFunction) {
    this.mySqlClient.query(
      insertQuery,
      function checkInsert(error, callbackFunction){
        if (error) {
          console.log(error);
          db.mySqlClient.end();
          return;
        }
        else  {
          callbackFunction;
        }
      });
  },
// Cherche l'ID Max, puis crée une room avec IDMax +1 et roomName
  createRoom : function (roomName) {
    //enregistre le nom de la nouvelel room dans une var pour la faire passer
    var newRoomName = roomName;
    //SQL: sélectionner le MaxID
    db.executeSelectQuery("SELECT Max(RoomID) FROM ROOMS", function(results){
      // +1 au MaxID
      this.newRoomId = parseInt(results[0]['Max(RoomID)']+1);
      console.log("DB: new room id = " +this.newRoomId+ " and name == " +newRoomName);
      //Enregistrer une nouvelle room
      db.executeInsertQuery("INSERT INTO ROOMS (RoomID, RoomName) VALUES ("+this.newRoomId+", '"+newRoomName+"')", 
        function() {
        console.log("DB: room created " + results[0] );
        db.mySqlClient.end();
        }
      );
    });
  },  

//Vérifie si la room "roomName" existe. 
//Si elle n'existe pas, appelle createRoom,
//Si elle existe, envoie les infos de la room à l'user
  checkIfRoom : function ( roomName ) {
    console.log("DB: checking if room "+roomName);
    this.mySqlClient.query(
      "SELECT * FROM ROOMS WHERE RoomName = '"+roomName+"'",
      function select(error, results, fields) {
        console.log("DB: results = "+results);
        if (error) {
          console.log("DB: "+error.stack);
          db.mySqlClient.end();
          return;
        }
   
        if ( results.length > 0 )  { 
          console.log("DB: room "+roomName+" exists already")
          db.getRoomInfo(roomName);
        } else {
          console.log("DB: "+roomName+" has yet to be created")
          db.createRoom(roomName);
        }
    });
  },

//Récupère les informations d'une room donnée
//les envoie à l'utilisateur
  getRoomInfo : function (roomName) {
    console.log("DB: getting room "+roomName+" info");
    db.mySqlClient.end();
  }
};